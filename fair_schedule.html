<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fair Work Schedule</title>
  <link rel="icon" href="pb-icon.png" type="image/png">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5faff; color: #333; margin: 0; padding: 0; }
    header { background-color: #0077cc; color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; }
    .nav-buttons a { background-color: white; color: #0077cc; padding: 8px 14px; border-radius: 5px; text-decoration: none; font-weight: bold; margin-left: 8px; }
    .container { max-width: 800px; margin: 40px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input, button { padding: 8px; margin: 6px 0; width: 100%; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background-color: #0077cc; color: white; cursor: pointer; }
    button:hover { background-color: #005fa3; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
    th { background-color: #0077cc; color: white; }
    .error { color: red; font-weight: bold; }
    .weekday { color: black; }
    .weekend { color: #004a99; font-weight: bold; }
    .special { color: darkred; font-weight: bold; }
    .top-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; }
    .month-title { font-size: 1.1em; margin-bottom: 8px; color: #333; }
  </style>
</head>
<body>
  <header>
    <h1>Fair Work Schedule</h1>
    <div class="nav-buttons">
      <a href="index.html">Home</a>
      <a href="publications.html">Publications</a>
      <a href="experience.html">Experience</a>
      <a href="talks.html">Talks</a>
      <a href="cv.html" target="_blank">CV</a>
      <a href="contact.html">Contact</a>
    </div>
  </header>

  <!-- Login -->
  <div class="container" id="login-container">
    <h2>Login</h2>
    <label>Username:</label>
    <input type="text" id="username" placeholder="Enter username">
    <label>Password:</label>
    <input type="password" id="password" placeholder="Enter password">
    <button onclick="checkLogin()">Login</button>
    <p id="login-error" class="error"></p>
  </div>

  <!-- Inputs -->
  <div class="container hidden" id="input-container">
    <div class="top-buttons">
      <button onclick="logout()">Log Out</button>
    </div>
    <h2>Enter Parameters</h2>
    <label>Year:</label>
    <input type="number" id="year" min="1900" max="2100" placeholder="e.g., 2025">
    <label>Month (1-12):</label>
    <input type="number" id="month" min="1" max="12" placeholder="e.g., 10">
    <label>Number of Workers (n):</label>
    <input type="number" id="n" min="1" placeholder="e.g., 6">
    <label>Preferred Weekend Off (e.g., [0,2,1,0]):</label>
    <input type="text" id="weekend_off" placeholder="e.g., [0,0,0,0,0,0]">
    <button onclick="generateSchedule()">Generate Schedule</button>
    <p id="input-error" class="error"></p>
  </div>

  <!-- Results -->
  <div class="container hidden" id="result-container">
    <div class="top-buttons">
      <button onclick="refreshInput()">New Input</button>
      <button onclick="logout()">Log Out</button>
    </div>
    <h2>Generated Schedule</h2>
    <div id="month-year" class="month-title"></div>
    <div id="schedule-output"></div>
  </div>

  <script>
    window.onload = function() {
      if (localStorage.getItem('loggedIn') === 'true') {
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('input-container').classList.remove('hidden');
      }
    };

    function checkLogin() {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      const err = document.getElementById('login-error');
      if (user === 'popcorn' && pass === 'Popcorn22') {
        localStorage.setItem('loggedIn', 'true');
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('input-container').classList.remove('hidden');
      } else {
        err.textContent = "Invalid username or password!";
      }
    }

    function logout() {
      localStorage.removeItem('loggedIn');
      document.getElementById('input-container').classList.add('hidden');
      document.getElementById('result-container').classList.add('hidden');
      document.getElementById('login-container').classList.remove('hidden');
    }

    function refreshInput() {
      document.getElementById('result-container').classList.add('hidden');
      document.getElementById('input-container').classList.remove('hidden');
      document.getElementById('input-error').textContent = '';
      document.getElementById('n').value = '';
      document.getElementById('year').value = '';
      document.getElementById('month').value = '';
      document.getElementById('weekend_off').value = '';
    }

    // --- Core scheduling heuristic ---
    function generateSchedule() {
      const n = parseInt(document.getElementById('n').value);
      const month = parseInt(document.getElementById('month').value);
      const year = parseInt(document.getElementById('year').value);
      const weekend_off_input = document.getElementById('weekend_off').value.trim();
      const err = document.getElementById('input-error');
      err.textContent = "";

      if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
        err.textContent = "Please enter a valid year and month (1â€“12)."; return;
      }
      if (isNaN(n) || n <= 0) {
        err.textContent = "Number of workers must be a positive integer."; return;
      }

      let weekend_off;
      try {
        weekend_off = JSON.parse(weekend_off_input);
        if (!Array.isArray(weekend_off)) throw "Not array";
      } catch {
        err.textContent = "Weekend off must be a valid array, e.g., [0,2,1,0]."; return;
      }
      if (weekend_off.length !== n) { err.textContent = `The weekend_off vector must have length ${n}.`; return; }

      const daysInMonth = new Date(year, month, 0).getDate();
      const dow = (d) => new Date(year, month - 1, d).getDay(); // 0=Sun ... 6=Sat
      const daysShort = ['Su','M','T','W','Th','F','Sa'];

      const weights = Array.from({length: daysInMonth}, (_,i) => {
        const dayIdx = dow(i+1);
        return (dayIdx === 0 || dayIdx === 6) ? 1.0 : 0.5;
      });

      const schedule = Array.from({length: n}, () => Array(daysInMonth).fill(0));
      const points = Array(n).fill(0);

      // Build weekendStarts array
      const weekendStarts = [];
      for (let d = 1; d <= daysInMonth; d++) if (dow(d) === 6) weekendStarts.push(d-1);
      const weekendOffMap = Array(n).fill(-1);
      for (let i = 0; i < n; i++) {
        const w = weekend_off[i];
        if (Number.isInteger(w) && w > 0 && w <= weekendStarts.length) weekendOffMap[i] = weekendStarts[w-1];
      }

      // eligible() function (3 weekdays in a row, Sun+Mon)
      function eligible(i,d) {
        const prev1 = d-1, prev2 = d-2;
        if (prev1 >= 0 && prev2 >= 0) {
          const p1 = dow(prev1+1), p2 = dow(prev2+1);
          if (p1>=1&&p1<=5 && p2>=1&&p2<=5) if (schedule[i][prev1]===1 && schedule[i][prev2]===1) return false;
        }
        if (dow(d+1)===0 && d+1<daysInMonth && schedule[i][d+1]===1) return false;
        return true;
      }

      function addPoints(i,d) { points[i] += weights[d]; }

      function chooseCandidates(d,k) {
        const arr=[];
        const dayIdx = dow(d+1);
        const isWeekend = (dayIdx===6||dayIdx===0);
        for (let i=0;i<n;i++){
          let saturdayIndex = (dayIdx===6)?d:d-1;
          if (isWeekend && saturdayIndex>=0 && weekendOffMap[i]===saturdayIndex) continue;
          if (schedule[i][d]>0) continue;
          if (!eligible(i,d)) continue;
          arr.push({i,p:points[i]});
        }
        arr.sort((a,b)=>a.p-b.p||a.i-b.i);
        return arr.slice(0,k).map(x=>x.i);
      }

      // MAIN ASSIGNMENT LOOP
      for (let d=0; d<daysInMonth; d++){
        const dayIdx=dow(d+1);
        const isSaturday=dayIdx===6, isSunday=dayIdx===0;
        const required=isSaturday||isSunday?2:1;

        if(isSaturday){
          let pair=chooseCandidates(d,2);
          if(pair.length<2){
            const fallback=[];
            for(let i=0;i<n;i++){ if(weekendOffMap[i]!==d && schedule[i][d]===0) fallback.push({i,p:points[i]}); }
            fallback.sort((a,b)=>a.p-b.p||a.i-b.i);
            for(let f of fallback) if(!pair.includes(f.i)) pair.push(f.i);
            pair.splice(2);
          }
          for(const i of pair){ schedule[i][d]=2; addPoints(i,d); if(d+1<daysInMonth && dow(d+2)===0){schedule[i][d+1]=2; addPoints(i,d+1);} }
        } else if(isSunday){ 
          if(schedule.some(row=>row[d]>0)) continue;
          const candidates=chooseCandidates(d,2); for(let idx=0;idx<Math.min(2,candidates.length);idx++){ schedule[candidates[idx]][d]=2; addPoints(candidates[idx],d); }
        } else { 
          const candidates=chooseCandidates(d,1); if(candidates.length>0){ const chosen=candidates[0]; schedule[chosen][d]=1; addPoints(chosen,d);
            if(dayIdx===5){ const satIndex=d+1, sunIndex=d+2; if(satIndex<daysInMonth && dow(satIndex+1)===6 && weekendOffMap[chosen]!==satIndex){ if(schedule[chosen][satIndex]===0){schedule[chosen][satIndex]=1; addPoints(chosen,satIndex);} if(sunIndex<daysInMonth && schedule[chosen][sunIndex]===0){schedule[chosen][sunIndex]=1; addPoints(chosen,sunIndex);} } }
          }
        }
      }

      // --- Compute fairness ---
      const total_points = points.slice();
      const avg_points = total_points.reduce((a,b)=>a+b,0)/n;
      const delta = total_points.map(p=>Math.abs(p-avg_points));

      // --- Prepare output ---
      document.getElementById('input-container').classList.add('hidden');
      document.getElementById('result-container').classList.remove('hidden');
      const monthName = new Date(year, month-1, 1).toLocaleString(undefined,{month:'long'});
      document.getElementById('month-year').textContent = `Schedule for ${monthName} ${year}`;
      const outDiv=document.getElementById('schedule-output');
      outDiv.innerHTML=createCompactTable(schedule, daysShort, year, month, weights, total_points, delta);
      document.getElementById('result-container').scrollIntoView({behavior:'smooth'});
    }

    function createCompactTable(schedule, days, year, month, weights, total_points, delta){
      let tableHTML=`<table><tr><th>Worker</th><th>Assigned Dates</th></tr>`;
      for(let i=0;i<schedule.length;i++){
        let assignments=[];
        for(let d=0;d<schedule[i].length;d++){
          const val=schedule[i][d];
          if(val>0){
            const dayIdx=new Date(year, month-1,d+1).getDay();
            const dayName=days[dayIdx];
            let colorClass="";
            if(val===2) colorClass="special";
            else colorClass="weekday";
            assignments.push(`<span class="${colorClass}">${d+1}(${dayName})</span>`);
          }
        }
        tableHTML+=`<tr><td><b>Worker ${i+1}</b></td><td>${assignments.join(', ') || '<i>none</i>'}</td></tr>`;
      }
      tableHTML+=`</table>`;
      tableHTML+=`<p><b>Total points per worker:</b> [${total_points.map(p=>p.toFixed(1)).join(', ')}]</p>`;
      tableHTML+=`<p><b>Fairness deviation (delta):</b> [${delta.map(d=>d.toFixed(1)).join(', ')}]</p>`;
      return tableHTML;
    }
  </script>
</body>
</html>
